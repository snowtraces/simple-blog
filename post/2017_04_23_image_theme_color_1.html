<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寻觅</title>
    <style>
        html,
        body {
            font-family: "Times New Roman", serif;
            background: #eceff1;
            margin: 0;
            padding: 0;
            height: 100%;
        }

        * {
            box-sizing: border-box;
        }
        .hide {
            display: none;
        }

        pre {
            margin: 1em 0;
        }

        img,
        table {
            max-width: 100%;
        }

        .container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        .sidebar {
            max-width: 450px;
            flex: 1;
            background-color: #e0e0e0;
            overflow-y: auto;
            padding: 35px;
        }

        .sidebar h2 {
            border-bottom: 1px solid #ccc;
            padding-bottom: 1rem;
        }

        .sidebar h2 span {
            font-size: 0.75rem;
            font-family: serif;
            font-weight: 500;
            color: #999;
            vertical-align: bottom;
            padding-left: 10px;
        }


        .main-content {
            flex: 2;
            background-color: #fbfbfb;
            overflow-y: auto;
            padding: 30px;
        }

        h1 {
            color: #000033 !important;
            font-weight: bold;
            font-size: xx-large;
            text-align: center;
            line-height: 1.2;
        }

        h1>a,
        h2>a {
            color: #000033 !important;
            text-decoration: none;
        }

        .single-post .post-title {
            overflow: hidden;
            position: sticky;
            top: -31px;
            background-color: #fbfbfb;
            z-index: 1;
        }

        .title-meta {
            padding-bottom: 0.5em;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }

        .main-content>* {
            font-style: normal;
            text-align: justify;
            line-height: 165%;
            max-width: 960px;
            margin: auto;
        }

        p>code {
            font-size: 0.85rem;
            padding: 2px 3px;
            margin: 0 3px;
            border-radius: 3px;
            background-color: #e2e2e2;
            font-family: Consolas, Monaco, monospace;
        }

        .table-wrapper {
            width: 100%;
            overflow: auto;
            margin: 1rem 0;
        }

        table {
            border-collapse: collapse;
            border: 2px solid rgb(140 140 140);
            font-size: 0.8rem;
            line-height: 1.2;
            width: 100%;
            padding: 0.5rem;
        }

        thead,
        tfoot {
            background-color: rgb(228 240 245);
        }

        th,
        td {
            border: 1px solid rgb(160 160 160);
            padding: 8px 10px;
        }

        tbody>tr:nth-of-type(even) {
            background-color: rgb(237 238 242);
        }

        tfoot th {
            text-align: right;
        }

        tfoot td {
            font-weight: bold;
        }

        #post-index {
            font-size: 0.875rem;
        }

        .post-index-grp {
            margin-bottom: 0.5em;
        }

        .post-index-date {
            color: #999;
            font-size: 0.875em;
        }

        a.nav-post-link {
            color: #333;
        }

        a.nav-post-link:hover {
            color: #000;
        }

        /* response */
        @media screen and (max-width: 1100px) {
            .container {
                display: block;
                overflow-y: scroll;
            }

            .main-content {
                overflow-y: visible;
            }

            .single-post .post-title {
                top: -1px;
            }


            .sidebar {
                max-width: 100%;
                padding: 1rem;
            }
        }
    </style>
<link rel="stylesheet" href="/css/hight.css?version=1723974088984"></head>

<body>
    <div class="container">

        <div class="sidebar">
            <h2> <a href="/">寻觅</a> <span>路漫漫其修远兮, 吾将上下而求索</span></h2>
            <div id="post-index">
                <div class="post-index-grp">
                    <div class="post-index-date">2024-08-07</div>
                    
                        <a class="nav-post-link" href="/post/2024_08_01_database_index_design.html">数据库索引设计</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2019-08-30</div>
                    
                        <a class="nav-post-link" href="/post/2019_08_30_001_fastjson_http_message_converter.html">FastJsonHttpMessageConverter转义字符串问题处理</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2019-06-11</div>
                    
                        <a class="nav-post-link" href="/post/2019_06_11_001_pinyin_split_algorithm.html">拼音拆分算法</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2018-06-14</div>
                    
                        <a class="nav-post-link" href="/post/2018_06_14_001_mysql_non-mainstream_fuzzy_query_full-text_index.html">MySQL非主流模糊查询: 全文索引</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2018-02-25</div>
                    
                        <a class="nav-post-link" href="/post/2018_02_25_image_theme_color_2.html">图像主题色提取简单实现（二）</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-08-12</div>
                    
                        <a class="nav-post-link" href="/post/2017_08_12_the_use_of_mysql_index.html">MySql索引的使用</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-08-07</div>
                    
                        <a class="nav-post-link" href="/post/2017_08_07_sql_optimization_for_paging_query.html">分页查询时SQL优化</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-04-23</div>
                    
                        <a class="nav-post-link" href="/post/2017_04_23_image_theme_color_1.html">图像主题色提取简单实现</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-03-02</div>
                    
                        <a class="nav-post-link" href="/post/2017_03_02_optimization_of_regular_expressions.html">正则表达式的优化</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-01-06</div>
                    
                        <a class="nav-post-link" href="/post/2017_01_06_cpu_branch_prediction.html">CPU 分支预测</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2016-12-01</div>
                    
                        <a class="nav-post-link" href="/post/2016_12_01_nine_simple_css_image_filters.html">9个简单的CSS图像滤镜</a>
                    
                </div>
                </div>
        </div>
        <div class="main-content">
            <div id="main"><div class="post single-post">
        <div class="post-title">
            <h1>图像主题色提取简单实现</h1>
            <div class="title-meta">
                <span class="meta-author">snowtraces</span> / <span class="meta-time">2017-04-23</span>
            </div>
        </div>
        <div class="post-content">
            <p>图像主题颜色的应用越来越多，如<a title="google相册" href="https://photos.google.com/" target="_blank">google相册</a>可以按照颜色对图片进行检索，<a title="design-seeds" href="https://www.design-seeds.com/" target="_blank">design-seeds</a>上的色彩设计。相关算法主要有中位切分法、八叉树提取法和KMean clustering 等算法。关于这些算法，推荐这两篇文章，写的非常好：<a title="图像主题色提取算法" href="http://blog.rainy.im/2015/11/24/extract-color-themes-from-images/" target="_blank">图像主题色提取算法</a>和<a title="图片主题色提取算法小结" href="http://blog.rainy.im/2015/11/24/extract-color-themes-from-images/" target="_blank">图片主题色提取算法小结</a>，本文只就中位切分法（Median cut）进行js的简单实现。</p><p>RGB色彩模式下，R/G/B的取值分别为0x00~0xff（0~255），将其想象成一个以RGB分别为维度的三维空间，在取值范围内构成一个立方体</p><p><img title="640px-RGB_color_solid_cube-300x225" src="/data/static/image/post_0007/640px-RGB_color_solid_cube-300x225.png"></p><p>此处我以空间均等八分为例（R/G/B各以128切分），取得八个空间的像素点分布，计算其平均值。</p><h2>HTML代码
</h2><pre class="line-numbers language-html"><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="zh-CN"&gt;
&lt;head&gt;
	&lt;meta charset="UTF-8" /&gt;
	&lt;link rel="stylesheet" href="style.css"&gt;
	&lt;script src="jquery-2.1.0.js"&gt;&lt;/script&gt;
	&lt;script src="octree.js"&gt;&lt;/script&gt;
	&lt;script src="color.js"&gt;&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;img src="image/044a.jpg" id="image"/&gt;

&lt;div id="colorx"&gt;&lt;/div&gt;
&lt;div id="colory"&gt;&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre><h2>JS代码
</h2><h3>color.js
</h3><pre class="line-numbers language-javascript"><code class="language-javascript">$(function() {
  function rgb(r, g, b, count) {
    this.r = r;
    this.g = g;
    this.b = b;
    this.count = count;
  }

  $("#image").one("load",function() {
    var blockSize = 47, // 选取密度
    canvas = document.createElement('canvas'), // 画布
    context = canvas.getContext('2d'), data, width, height, i = -4, length, red, green, blue, count = 0, rgbArray = [];
    for (var j = 0; j &lt; 8; j++) {
      rgbArray[j] = new rgb(0, 0, 0, 0);
    }
    if (!context) {
      // 未获取，设置默认值
      // rgb = { r: 51, g: 104, b: 172 }
    } else {
      height = canvas.height = this.naturalHeight;
      width = canvas.width = this.naturalWidth;
      context.drawImage(this, 0, 0);
      try {
        data = context.getImageData(0, 0, width, height);
        length = data.data.length;
        // 将颜色放入对应位置
        while ((i += blockSize * 4) &lt; length) {
          var rIndex = (data.data[i] - 128) &gt;&gt; 31;
          var gIndex = (data.data[i + 1] - 128) &gt;&gt; 31;
          var bIndex = (data.data[i + 2] - 128) &gt;&gt; 31;
          var index = ((rIndex + 1) &lt;&lt; 2) + ((gIndex + 1) &lt;&lt; 1)
              + (bIndex + 1); // 计算二进制索引
          rgbArray[index].r += data.data[i];
          rgbArray[index].g += data.data[i + 1];
          rgbArray[index].b += data.data[i + 2];
          rgbArray[index].count++;
        }
  
        rgbArray.sort(function(a, b) {
          return a.count - b.count
        })
        // 计算最终颜色
        var html = "";
        for (var k = 0; k &lt; 8; k++) {
          var r = ~~(rgbArray[k].r / rgbArray[k].count);
          var b = ~~(rgbArray[k].b / rgbArray[k].count);
          var g = ~~(rgbArray[k].g / rgbArray[k].count);
          var rStr = r.toString(16);
          var gStr = g.toString(16);
          var bStr = b.toString(16);
          if (rStr.length === 1)
            rStr = '0' + rStr;
          if (gStr.length === 1)
            gStr = '0' + gStr;
          if (bStr.length === 1)
            bStr = '0' + bStr;
  
          var colorStr = rStr + gStr + bStr;
          if ("000000" != colorStr)
            html += "&lt;div class=\"color\" style=\"background:#"
                + colorStr + "\"&gt;#" + colorStr + "&lt;/div&gt;";
        }
        $("#colory").append(html).append("&lt;div class=\"clear\"&gt;&lt;/div&gt;");
      } catch (e) {
        console.info(e)
        //rgb = { r: 51, g: 104, b: 172 }
      }
    }
  })
})</code></pre><h3>octree.js
</h3><p>这段代码是抄别人的： <a title="图片主题色提取算法小结" href="https://xcoder.in/2014/09/17/theme-color-extract/" target="_blank">图片主题色提取算法小结</a> ，作为上面实现的对照。原代码中有个节点的选择貌似又问题，我改了以后效果良好……</p><pre class="line-numbers language-javascript"><code class="language-javascript">$(function () {
  $("#image").load(function () {
    getColor();
  })

  var reducible = [];
  var leafNum = 0;
  var blockSize = 47; //取值密度
  var colorNum = 8;// 提取颜色数目
  for (var i = 0; i &lt; 8; i++)
    reducible.push(null);
  // 八叉树节点
  var OctreeNode = function () {
    this.isLeaf = false;// 默认不是子节点
    this.pixelCount = 0;// 该节点插入颜色的次数
    this.red = 0;// 通道颜色值，逐步累加
    this.green = 0;
    this.blue = 0;

    // 兄弟节点初始化
    this.children = new Array(8);
    for (var i = 0; i &lt; this.children.length; i++)
      this.children[i] = null;

    // 这里的 next 不是指兄弟链中的 next 指针
    // 而是在 reducible 链表中的下一个节点
    this.next = null;
  };
  var root = new OctreeNode();

  /**
   * 获取颜色并输出至页面
   * @returns
   */
  function getColor() {
    var pixels = getPixels("image");
    var data = pixels.data;
    var array = [];
    //像素点转换成rgb颜色信息
    for (var i = 0; i &lt; data.length; i += 4 * blockSize) {
      var r = data[i];
      var g = data[i + 1];
      var b = data[i + 2];
      array.push({ r: r, g: g, b: b });
    }
    //传入颜色信息，开始建树
    buildOctree(array, colorNum);

    var colors = {};
    colorsStats(root, colors);

    var result = [];
    for (var key in colors) {
      result.push({ color: key, count: colors[key] });
    }

    result.sort(function (a, b) {
      return a.count - b.count;
    });
    var string = "";
    for (var i = 0; i &lt; result.length; i++) {
      string += "&lt;div class=\"color\" style=\"background:#" + result[i].color + "\"&gt;#" + result[i].color + "&lt;/div&gt;";
    }
    $("#colorx").append(string).append("&lt;div class=\"clear\"&gt;&lt;/div&gt;");
    console.log("统计结果：" + result.length)
    console.log("done");
  }

  /**
   * 获取像素信息
   * 
   * @param {String}image
   *          图片名称
   * @returns
   */
  function getPixels(imageId) {
    var canvas = document.createElement('canvas'), // 创建画布
      context = canvas.getContext('2d'), data, width, height,
      imgEl = document.getElementById(imageId);
    if (!context) {
      console.log("未获取有效图像数据")
    } else {
      height = canvas.height = imgEl.naturalHeight;
      width = canvas.width = imgEl.naturalWidth;
      console.log("" + width + "  " + height)
      context.drawImage(imgEl, 0, 0);
      try {
        data = context.getImageData(0, 0, width, height);
        return data;
      } catch (e) {
        console.log("---无法读取图像---");
      }
    }
    return null;
  }

  /**
   * createNode
   * 
   * @param {OctreeNode}
   *          parent the parent node of the new node
   * @param {Number}
   *          idx child index in parent of this node
   * @param {Number}
   *          level node level
   * @return {OctreeNode} the new node
   */
  function createNode(level) {
    var node = new OctreeNode();
    if (level === 7) {
      node.isLeaf = true;
      leafNum++;
    } else {
      node.next = reducible[level + 1];
      reducible[level + 1] = node;
    }

    return node;
  }

  /**
   * addColor
   * 
   * @param {OctreeNode}
   *          node the octree node
   * @param {Object}
   *          color color object
   * @param {Number}
   *          level node level
   * @return {undefined}
   */
  function addColor(node, color, level) {
    if (node.isLeaf) {
      node.pixelCount++;
      node.red += color.r;
      node.green += color.g;
      node.blue += color.b;
    } else {
      // 由于 js 内部都是以浮点型存储数值，所以位运算并没有那么高效
      // 在此使用直接转换字符串的方式提取某一位的值
      //      var str = "";
      //      var r = color.r.toString(2);
      //      var g = color.g.toString(2);
      //      var b = color.b.toString(2);
      //      while (r.length &lt; 8)
      //        r = '0' + r;
      //      while (g.length &lt; 8)
      //        g = '0' + g;
      //      while (b.length &lt; 8)
      //        b = '0' + b;
      //
      //      str += r[level];
      //      str += g[level];
      //      str += b[level];
      //      var idx = parseInt(str, 2);
      var r = (color.r &gt;&gt; (7 - level)) &amp; 1;
      var g = (color.g &gt;&gt; (7 - level)) &amp; 1;
      var b = (color.b &gt;&gt; (7 - level)) &amp; 1;
      var idx = (r &lt;&lt; 2) + (g &lt;&lt; 1) + b;

      if (null === node.children[idx]) {
        node.children[idx] = createNode(level + 1);
      }

      if (undefined === node.children[idx]) {
        console.log(color)
        console.log(color.r.toString(2));
      }

      addColor(node.children[idx], color, level + 1);
    }
  }

  /**
   * reduceTree
   * 
   * @return {undefined}
   */
  function reduceTree() {
    // find the deepest level of node
    var level = 7;
    while (null === reducible[level])
      level--;
    // get the node and remove it from reducible link
    var node = reducible[level];
    reducible[level] = node.next;
    // merge children
    var r = 0;
    var g = 0;
    var b = 0;
    var count = 0;
    for (var i = 0; i &lt; 8; i++) {
      if (null === node.children[i])
        continue;
      r += node.children[i].red;
      g += node.children[i].green;
      b += node.children[i].blue;
      count += node.children[i].pixelCount;
      leafNum--;
    }

    node.isLeaf = true;
    node.red = r;
    node.green = g;
    node.blue = b;
    node.pixelCount = count;
    leafNum++;
  }

  /**
   * buildOctree
   * 
   * @param {Array}
   *          pixels The pixels array
   * @param {Number}
   *          maxColors The max count for colors
   * @return {undefined}
   */
  function buildOctree(pixels, maxColors) {
    for (var i = 0; i &lt; pixels.length; i++) {
      // 添加颜色
      addColor(root, pixels[i], 0);

      // 合并叶子节点
      while (leafNum &gt; maxColors)
        reduceTree();
    }
  }

  /**
   * colorsStats
   * 
   * @param {OctreeNode}
   *          node the node will be stats
   * @param {Object}
   *          object color stats
   * @return {undefined}
   */
  function colorsStats(node, object) {
    if (node.isLeaf) {
      var r = parseInt(node.red / node.pixelCount).toString(16);
      var g = parseInt(node.green / node.pixelCount).toString(16);
      var b = parseInt(node.blue / node.pixelCount).toString(16);
      if (r.length === 1)
        r = '0' + r;
      if (g.length === 1)
        g = '0' + g;
      if (b.length === 1)
        b = '0' + b;

      var color = r + g + b;
      if (object[color])
        object[color] += node.pixelCount;
      else
        object[color] = node.pixelCount;

      return;
    }

    for (var i = 0; i &lt; 8; i++) {
      if (null !== node.children[i]) {
        colorsStats(node.children[i], object);
      }
    }
  }
})</code></pre><h2>结果展示
</h2><p><img title="color" src="/data/static/image/post_0007/color.jpg"></p><p>其中第一排颜色是根据<a title="图片主题色提取算法小结" href="https://xcoder.in/2014/09/17/theme-color-extract/" target="_blank">图片主题色提取算法小结</a>中的八叉树算法提取的，这张图片色域比较大，两种结果较非常接近，下面更换图片看看结果</p><p><img title="color2" src="/data/static/image/post_0007/color2.jpg"></p><p>结果依旧相近，但中位切分法获取了一个<code>#000000</code>结果被过滤了。</p><h2>执行效率
</h2><p>在效率上，如本文中八均分的中位切分效率还算可观，但是一旦目标颜色数目上升后，效率会大大降低。对于八叉树算法，先进行颜色遍历建树，然后根据目标颜色树进行合并，目标颜色数目越多，合并的次数会越少，计算效率不降反升。</p>
        </div>
        <div class="post-image"></div>
        <ul class="post-menu"></ul>
    </div></div>
        </div>
    </div>
    
    <script>
        window.addEventListener("popstate", function (e) {
            let path = window.location.href
            let url_segs = path.split('#')
            if (url_segs.length >= 3) {
                let cat = url_segs[1]
                let param = url_segs[2]
                if (cat === 'post') {
                    window.eventHub.emit('post-detail', { data: param })
                }
            } else {
                window.eventHub.emit('post-list', { pushStat: false })
            }
        }, false);
    </script>


<script src="/js/util/function.js?version=1723974088984"></script><script src="/js/util/markdown.js?version=1723974088984"></script><script src="/js/util/event-hub.js?version=1723974088984"></script><script src="/js/entity.js?version=1723974088984"></script><script src="/js/3rdparty/prism.js?version=1723974088984"></script><script src="https://static.codepen.io/assets/embed/ei.js?version=1723974088984"></script><script src="/js/util/saveData.js?version=1723974088984"></script></body></html>