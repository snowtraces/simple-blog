<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寻觅</title>
    <style>
        html,
        body {
            font-family: "Times New Roman", serif;
            background: #eceff1;
            margin: 0;
            padding: 0;
            height: 100%;
        }

        * {
            box-sizing: border-box;
        }
        .hide {
            display: none;
        }

        pre {
            margin: 1em 0;
        }

        img,
        table {
            max-width: 100%;
        }

        .container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        .sidebar {
            max-width: 450px;
            flex: 1;
            background-color: #e0e0e0;
            overflow-y: auto;
            padding: 35px;
        }

        .sidebar h2 {
            border-bottom: 1px solid #ccc;
            padding-bottom: 1rem;
        }

        .sidebar h2 span {
            font-size: 0.75rem;
            font-family: serif;
            font-weight: 500;
            color: #999;
            vertical-align: bottom;
            padding-left: 10px;
        }


        .main-content {
            flex: 2;
            background-color: #fbfbfb;
            overflow-y: auto;
            padding: 30px;
        }

        h1 {
            color: #000033 !important;
            font-weight: bold;
            font-size: xx-large;
            text-align: center;
            line-height: 1.2;
        }

        h1>a,
        h2>a {
            color: #000033 !important;
            text-decoration: none;
        }

        .single-post .post-title {
            overflow: hidden;
            position: sticky;
            top: -31px;
            background-color: #fbfbfb;
            z-index: 1;
        }

        .title-meta {
            padding-bottom: 0.5em;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }

        .main-content>* {
            font-style: normal;
            text-align: justify;
            line-height: 165%;
            max-width: 960px;
            margin: auto;
        }

        p>code {
            font-size: 0.85rem;
            padding: 2px 3px;
            margin: 0 3px;
            border-radius: 3px;
            background-color: #e2e2e2;
            font-family: Consolas, Monaco, monospace;
        }

        .table-wrapper {
            width: 100%;
            overflow: auto;
            margin: 1rem 0;
        }

        table {
            border-collapse: collapse;
            border: 2px solid rgb(140 140 140);
            font-size: 0.8rem;
            line-height: 1.2;
            width: 100%;
            padding: 0.5rem;
        }

        thead,
        tfoot {
            background-color: rgb(228 240 245);
        }

        th,
        td {
            border: 1px solid rgb(160 160 160);
            padding: 8px 10px;
        }

        tbody>tr:nth-of-type(even) {
            background-color: rgb(237 238 242);
        }

        tfoot th {
            text-align: right;
        }

        tfoot td {
            font-weight: bold;
        }

        #post-index {
            font-size: 0.875rem;
        }

        .post-index-grp {
            margin-bottom: 0.5em;
        }

        .post-index-date {
            color: #999;
            font-size: 0.875em;
        }

        a.nav-post-link {
            color: #333;
        }

        a.nav-post-link:hover {
            color: #000;
        }

        /* response */
        @media screen and (max-width: 1100px) {
            .container {
                display: block;
                overflow-y: scroll;
            }

            .main-content {
                overflow-y: visible;
            }

            .single-post .post-title {
                top: -1px;
            }


            .sidebar {
                max-width: 100%;
                padding: 1rem;
            }
        }
    </style>
<link rel="stylesheet" href="/css/hight.css?version=1723974088984"></head>

<body>
    <div class="container">

        <div class="sidebar">
            <h2> <a href="/">寻觅</a> <span>路漫漫其修远兮, 吾将上下而求索</span></h2>
            <div id="post-index">
                <div class="post-index-grp">
                    <div class="post-index-date">2024-08-07</div>
                    
                        <a class="nav-post-link" href="/post/2024_08_01_database_index_design.html">数据库索引设计</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2019-08-30</div>
                    
                        <a class="nav-post-link" href="/post/2019_08_30_001_fastjson_http_message_converter.html">FastJsonHttpMessageConverter转义字符串问题处理</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2019-06-11</div>
                    
                        <a class="nav-post-link" href="/post/2019_06_11_001_pinyin_split_algorithm.html">拼音拆分算法</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2018-06-14</div>
                    
                        <a class="nav-post-link" href="/post/2018_06_14_001_mysql_non-mainstream_fuzzy_query_full-text_index.html">MySQL非主流模糊查询: 全文索引</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2018-02-25</div>
                    
                        <a class="nav-post-link" href="/post/2018_02_25_image_theme_color_2.html">图像主题色提取简单实现（二）</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-08-12</div>
                    
                        <a class="nav-post-link" href="/post/2017_08_12_the_use_of_mysql_index.html">MySql索引的使用</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-08-07</div>
                    
                        <a class="nav-post-link" href="/post/2017_08_07_sql_optimization_for_paging_query.html">分页查询时SQL优化</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-04-23</div>
                    
                        <a class="nav-post-link" href="/post/2017_04_23_image_theme_color_1.html">图像主题色提取简单实现</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-03-02</div>
                    
                        <a class="nav-post-link" href="/post/2017_03_02_optimization_of_regular_expressions.html">正则表达式的优化</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-01-06</div>
                    
                        <a class="nav-post-link" href="/post/2017_01_06_cpu_branch_prediction.html">CPU 分支预测</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2016-12-01</div>
                    
                        <a class="nav-post-link" href="/post/2016_12_01_nine_simple_css_image_filters.html">9个简单的CSS图像滤镜</a>
                    
                </div>
                </div>
        </div>
        <div class="main-content">
            <div id="main"><div class="post single-post">
        <div class="post-title">
            <h1>分页查询时SQL优化</h1>
            <div class="title-meta">
                <span class="meta-author">snowtraces</span> / <span class="meta-time">2017-08-07</span>
            </div>
        </div>
        <div class="post-content">
            <p>业务上表数据由百万上升到千万级别，涉及到多表联合分页查询，结果是查询超时。问题在于<code>JOIN</code>和<code>ORDER</code>的条件字段不一致，导致一个索引失效，排序时遍历了千万级别的中间表，最终超时。</p><p>解决办法有两个：让索引都生效或减小排序时中间表的长度。前者可以通过联合索引实现，各个数据库支持度不详；后者可以通过先查询出一部分结果再JOIN，中间表的长度有限效率就不是问题。项目中使用mysql，本文就以mysql为例说明。</p><h2>mysql 语句的执行流程
</h2><p>来源：<a title="MySQL的语句执行顺序" href="http://www.cnblogs.com/rollenholt/p/3776923.html" target="_blank">MySQL的语句执行顺序</a></p><pre class="line-numbers language-markup"><code class="language-markup">(8) SELECT (9) DISTINCT&lt;select_list&gt;
(1) FROM&lt;left_table&gt;
(3) &lt;join_type&gt;JOIN&lt;right_table&gt;
(2) ON&lt;join_condition&gt;
(4) WHERE&lt;where_condition&gt;
(5)	GROUP BY&lt;group_by_list&gt;
(6) WITH{CUBE|ROLLUP}
(7) HAVING&lt;having_condition&gt;
(10) ORDER BY&lt;ordr_by_list&gt;
(11) LIMIT&lt;limit_number&gt;</code></pre><ul><li>FORM: 对FROM的左边的表和右边的表计算笛卡尔积。产生虚表VT1</li><li>ON: 对虚表VT1进行ON筛选，只有那些符合&lt;join-condition&gt;的行才会被记录在虚表VT2中。</li><li>JOIN： 如果指定了OUTER JOIN（比如left join、 right join），那么保留表中未匹配的行就会作为外部行添加到虚拟表VT2中，产生虚拟表VT3, rug from子句中包含两个以上的表的话，那么就会对上一个join连接产生的结果VT3和下一个表重复执行步骤1~3这三个步骤，一直到处理完所有的表为止。</li><li>WHERE： 对虚拟表VT3进行WHERE条件过滤。只有符合&lt;where-condition&gt;的记录才会被插入到虚拟表VT4中。</li><li>GROUP BY: 根据group by子句中的列，对VT4中的记录进行分组操作，产生VT5.</li><li>CUBE | ROLLUP: 对表VT5进行cube或者rollup操作，产生表VT6.</li><li>HAVING： 对虚拟表VT6应用having过滤，只有符合&lt;having-condition&gt;的记录才会被 插入到虚拟表VT7中。</li><li>SELECT： 执行select操作，选择指定的列，插入到虚拟表VT8中。</li><li>DISTINCT： 对VT8中的记录进行去重。产生虚拟表VT9.</li><li>ORDER BY: 将虚拟表VT9中的记录按照&lt;order_by_list&gt;进行排序操作，产生虚拟表VT10.</li><li>LIMIT：取出指定行的记录，产生虚拟表VT11, 并将结果返回。</li></ul><p>个人觉得，以上只是执行流程而已，帮助理解很好，具体的执行优化等远远不止于此。</p><h2>sql查询优化
</h2><p>假设有表<code>table_a</code>，存在字段<code>id</code>、<code>name</code>和<code>age</code>，其中主键id有索引（默认），其余未设置索引。单表分页查询中，如果按<code>id</code>排序，结果是秒开；换成<code>age</code>排序后，由于没有索引，此时需要遍历整个表，随着表数据的增加查询会越来越慢，针对这种情况，只要为<code>age</code>设置索引即可。</p><p>现在又有表<code>table_b</code>，存在字段<code>id</code>和<code>sex</code>，其中主键<code>id</code>有索引（默认），其余未设置索引。现在需要多表查询，结果为<code>id</code>、<code>name</code>、<code>age</code>和<code>sex</code>。查询语句如下：</p><pre class="line-numbers language-sql"><code class="language-sql">SELECT 
    a.id,
    a.name,
    a.age,
    b.sex
FROM
    table_a a
LEFT JOIN table_b b USING (id)
ORDER BY a.age ASC
LIMIT 0,10</code></pre><p>以上因为对<code>age</code>排序，我们先对<code>age</code>设置好索引，但由于<code>LEFT JOIN</code>使用了不一样的索引，所以<code>age</code>和<code>id</code>的索引并不能同时生效，除非设置联合索引，以下的讨论均为不设置联合索引的情况。新的查询语句如下：</p><pre class="line-numbers language-sql"><code class="language-sql">SELECT 
    a.id,
    a.name,
    a.age,
    b.sex
FROM
(
    SELECT 
        id,
        name,
        age,
        sex
    FROM
        table_a
    ORDER BY age ASC
    LIMIT 0,10
) a
LEFT JOIN table_b b USING (id)
ORDER BY age ASC</code></pre><p>现在我们先使用万恶的子查询，但过程中使用了<code>age</code>索引进行排序，效率有保证，最后又一次排序，是因为<code>JOIN</code>过程中mysql的优化算法导致乱序了，这10条数据用不用索引都不是重点了。</p>
        </div>
        <div class="post-image"></div>
        <ul class="post-menu"></ul>
    </div></div>
        </div>
    </div>
    
    <script>
        window.addEventListener("popstate", function (e) {
            let path = window.location.href
            let url_segs = path.split('#')
            if (url_segs.length >= 3) {
                let cat = url_segs[1]
                let param = url_segs[2]
                if (cat === 'post') {
                    window.eventHub.emit('post-detail', { data: param })
                }
            } else {
                window.eventHub.emit('post-list', { pushStat: false })
            }
        }, false);
    </script>


<script src="/js/util/function.js?version=1723974088984"></script><script src="/js/util/markdown.js?version=1723974088984"></script><script src="/js/util/event-hub.js?version=1723974088984"></script><script src="/js/entity.js?version=1723974088984"></script><script src="/js/3rdparty/prism.js?version=1723974088984"></script><script src="https://static.codepen.io/assets/embed/ei.js?version=1723974088984"></script><script src="/js/util/saveData.js?version=1723974088984"></script></body></html>