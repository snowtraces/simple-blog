<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寻觅</title>
    <style>
        html,
        body {
            font-family: "Times New Roman", serif;
            background: #eceff1;
            margin: 0;
            padding: 0;
            height: 100%;
        }

        * {
            box-sizing: border-box;
        }
        .hide {
            display: none;
        }

        pre {
            margin: 1em 0;
        }

        img,
        table {
            max-width: 100%;
        }

        .container {
            display: flex;
            height: 100%;
            overflow: hidden;
        }

        .sidebar {
            max-width: 450px;
            flex: 1;
            background-color: #e0e0e0;
            overflow-y: auto;
            padding: 35px;
        }

        .sidebar h2 {
            border-bottom: 1px solid #ccc;
            padding-bottom: 1rem;
        }

        .sidebar h2 span {
            font-size: 0.75rem;
            font-family: serif;
            font-weight: 500;
            color: #999;
            vertical-align: bottom;
            padding-left: 10px;
        }


        .main-content {
            flex: 2;
            background-color: #fbfbfb;
            overflow-y: auto;
            padding: 30px;
        }

        h1 {
            color: #000033 !important;
            font-weight: bold;
            font-size: xx-large;
            text-align: center;
            line-height: 1.2;
        }

        h1>a,
        h2>a {
            color: #000033 !important;
            text-decoration: none;
        }

        .single-post .post-title {
            overflow: hidden;
            position: sticky;
            top: -31px;
            background-color: #fbfbfb;
            z-index: 1;
        }

        .title-meta {
            padding-bottom: 0.5em;
            text-align: center;
            border-bottom: 1px solid #ccc;
        }

        .main-content>* {
            font-style: normal;
            text-align: justify;
            line-height: 165%;
            max-width: 960px;
            margin: auto;
        }

        p>code {
            font-size: 0.85rem;
            padding: 2px 3px;
            margin: 0 3px;
            border-radius: 3px;
            background-color: #e2e2e2;
            font-family: Consolas, Monaco, monospace;
        }

        .table-wrapper {
            width: 100%;
            overflow: auto;
            margin: 1rem 0;
        }

        table {
            border-collapse: collapse;
            border: 2px solid rgb(140 140 140);
            font-size: 0.8rem;
            line-height: 1.2;
            width: 100%;
            padding: 0.5rem;
        }

        thead,
        tfoot {
            background-color: rgb(228 240 245);
        }

        th,
        td {
            border: 1px solid rgb(160 160 160);
            padding: 8px 10px;
        }

        tbody>tr:nth-of-type(even) {
            background-color: rgb(237 238 242);
        }

        tfoot th {
            text-align: right;
        }

        tfoot td {
            font-weight: bold;
        }

        #post-index {
            font-size: 0.875rem;
        }

        .post-index-grp {
            margin-bottom: 0.5em;
        }

        .post-index-date {
            color: #999;
            font-size: 0.875em;
        }

        a.nav-post-link {
            color: #333;
        }

        a.nav-post-link:hover {
            color: #000;
        }

        /* response */
        @media screen and (max-width: 1100px) {
            .container {
                display: block;
                overflow-y: scroll;
            }

            .main-content {
                overflow-y: visible;
            }

            .single-post .post-title {
                top: -1px;
            }


            .sidebar {
                max-width: 100%;
                padding: 1rem;
            }
        }
    </style>
<link rel="stylesheet" href="/css/hight.css?version=1723974088984"></head>

<body>
    <div class="container">

        <div class="sidebar">
            <h2> <a href="/">寻觅</a> <span>路漫漫其修远兮, 吾将上下而求索</span></h2>
            <div id="post-index">
                <div class="post-index-grp">
                    <div class="post-index-date">2024-08-07</div>
                    
                        <a class="nav-post-link" href="/post/2024_08_01_database_index_design.html">数据库索引设计</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2019-08-30</div>
                    
                        <a class="nav-post-link" href="/post/2019_08_30_001_fastjson_http_message_converter.html">FastJsonHttpMessageConverter转义字符串问题处理</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2019-06-11</div>
                    
                        <a class="nav-post-link" href="/post/2019_06_11_001_pinyin_split_algorithm.html">拼音拆分算法</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2018-06-14</div>
                    
                        <a class="nav-post-link" href="/post/2018_06_14_001_mysql_non-mainstream_fuzzy_query_full-text_index.html">MySQL非主流模糊查询: 全文索引</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2018-02-25</div>
                    
                        <a class="nav-post-link" href="/post/2018_02_25_image_theme_color_2.html">图像主题色提取简单实现（二）</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-08-12</div>
                    
                        <a class="nav-post-link" href="/post/2017_08_12_the_use_of_mysql_index.html">MySql索引的使用</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-08-07</div>
                    
                        <a class="nav-post-link" href="/post/2017_08_07_sql_optimization_for_paging_query.html">分页查询时SQL优化</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-04-23</div>
                    
                        <a class="nav-post-link" href="/post/2017_04_23_image_theme_color_1.html">图像主题色提取简单实现</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-03-02</div>
                    
                        <a class="nav-post-link" href="/post/2017_03_02_optimization_of_regular_expressions.html">正则表达式的优化</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2017-01-06</div>
                    
                        <a class="nav-post-link" href="/post/2017_01_06_cpu_branch_prediction.html">CPU 分支预测</a>
                    
                </div>
                
                <div class="post-index-grp">
                    <div class="post-index-date">2016-12-01</div>
                    
                        <a class="nav-post-link" href="/post/2016_12_01_nine_simple_css_image_filters.html">9个简单的CSS图像滤镜</a>
                    
                </div>
                </div>
        </div>
        <div class="main-content">
            <div id="main"><div class="post single-post">
        <div class="post-title">
            <h1>CPU 分支预测</h1>
            <div class="title-meta">
                <span class="meta-author">snowtraces</span> / <span class="meta-time">2017-01-06</span>
            </div>
        </div>
        <div class="post-content">
            <p>在JAVA数组遍历过程中，排序过后的数组处理起来更快，stackoverflow上有个问题——<a title="为什么已排序数组比未排序数组处理起来更快？" href="https://stackoverflow.com/questions/11227809/why-is-it-faster-to-process-a-sorted-array-than-an-unsorted-array" target="_blank">为什么已排序数组比未排序数组处理起来更快？</a>，本文将对此问题和<a title="mysticial" href="https://stackoverflow.com/users/922184/mysticial" target="_blank">mysticial</a>的回答翻译，并以此为基础稍微补充展开。</p><h2>问题：为什么排序后的数组处理起来更快
</h2><p>下面是原问题，仅保留Java的问题实现部分，关于C++的请自行查看原文。</p><pre class="line-numbers language-java"><code class="language-java">import java.util.Arrays;
import java.util.Random;

public class Main
{
    public static void main(String[] args)
    {
        // Generate data
        int arraySize = 32768;
        int data[] = new int[arraySize];

        Random rnd = new Random(0);
        for (int c = 0; c &lt; arraySize; ++c)
            data[c] = rnd.nextInt() % 256;

        // !!!添加以下排序，程序会快很多
        Arrays.sort(data);

        // Test
        long start = System.nanoTime();
        long sum = 0;

        for (int i = 0; i &lt; 100000; ++i)
        {
            // Primary loop
            for (int c = 0; c &lt; arraySize; ++c)
            {
                if (data[c] &gt;= 128)
                    sum += data[c];
            }
        }

        System.out.println((System.nanoTime() - start) / 1000000000.0);
        System.out.println("sum = " + sum);
    }
}</code></pre><p>我自己用Eclipse跑一下结果，结果耗时：#1 排序：2.712352148；#2 未排序：14.459905408</p><h2>答案：分支预测（Branch Prediction）
</h2><h3>什么是分支预测
</h3><p>想象一下铁路分叉口：</p><p><img title="muxnt.jpg" src="/data/static/image/post_0009/muxnt.jpg"></p><p>Image by Mecanismo, via Wikimedia Commons. Used under the CC-By-SA 3.0 license.</p><p>现在为了方便讨论，假设这是回到19世纪 – 在远距离或无线电通信尚未普及之前。你是一个交汇处的扳道工，听到火车来，但你不知道它该走哪条路。你叫停火车，问清司机行驶方向，然后设置轨道。</p><p>火车很重，有很大的惯性，所以一路上一直加速和减速。</p><p>有更好的方法吗？ 你猜火车哪个方向去！</p><ul><li>如果猜到，继续。</li><li>如果猜错，停下来并后退，然后重设轨道。 火车重新启动驶入路径。</li></ul><p>对于一个if条件语句，在处理器级别，它是一个分支指令：</p><p><img title="if-statement-and-branch-instruction.png" src="/data/static/image/post_0009/if-statement-and-branch-instruction.png"></p><p>如果你是一个处理器，看到一个分支时并不知道选哪一个。 于是暂停执行并等待，直到前面的选择指令完成，然后继续执行正确的路径。</p><p>但是，现代处理器复杂且具有长流水线（pipelines），所以会一直“减速”“加速”，很浪费时间。分支预测器让使用指令流水线处理器的性能提高。</p><p>分支预测器猜测两路分支中哪一路最可能发生，然后投机执行这一路的指令，来避免流水线停顿造成的时间浪费。如果后来发现分支预测错误，那么流水线中投机执行的那些中间结果全部放弃，重新获取正确的分支路线上的指令开始执行，这招致了程序执行的延迟。</p><p>现代处理器的分支预测方法依赖于代码执行的动态历史信息。大多数应用程序具有良好的分支， 因此，分支预测器通常会实现&gt; 90%的命中率。 但是当面对不可预知的分支，没有可识别的模式，分支预测器实际上是无用的。</p><p>更多参见维基百科<a title="分支预测器" href="https://zh.wikipedia.org/wiki/%E5%88%86%E6%94%AF%E9%A0%90%E6%B8%AC%E5%99%A8" target="_blank">分支预测器</a>词条，介绍了多种分支预测的实现方法。</p><h3>原因是if条件语句
</h3><p>综上所述，罪魁祸首是这个if条件语句：</p><pre class="line-numbers language-java"><code class="language-java">if (data[c] &gt;= 128)
    sum += data[c];</code></pre><p>注意，数据均匀分布在0和255之间。当数据排序后，大致上半个迭代将不会进入if语句； 之后，数据均将进入if语句。</p><p>这对分支预测器非常友好，因为分支连续地沿着相同的方向多次行进。除了在切换方向之后的几个迭代， 一个简单的饱和计数器都能正确地预测分支结果。</p><p>简要分析一下：</p><pre class="line-numbers language-markup"><code class="language-markup">T = branch taken
N = branch not taken

data[] = 0, 1, 2, 3 ... 126, 127, 128, 129, 130, ... 250, 251, 252, ...
branch = N  N  N  N ...   N    N    T    T    T  ...   T    T    T  ...

       = NNNNNNNNN ... NNNNNNNTTTTTTTTT ... TTTTTTTTTT  (很容易预测)</code></pre><p>然而，当数据完全随机时，分支预测器毫无用处，因为它不能预测随机数据。 结果是可能会有大约50%的误预测，不比随机猜测更好。</p><pre class="line-numbers language-"><code class="language-">data[] = 226, 185, 125, 158, 198, 144, 217, 79, 202, 118,  14 ...
branch =   T,   T,   N,   T,   T,   T,   T,  N,   T,   N,   N ...

       = TTNTTTTNTNN ...   (完全随机，无法预测)</code></pre><h3>优化方案
</h3><p>通过位运算来避免分支预测，用下面代码来提换if条件语句：</p><pre class="line-numbers language-java"><code class="language-java">int t = (data[c] - 128) &gt;&gt; 31;
sum += ~t &amp; data[c];</code></pre><p>介绍相关的按位操作符和移位操作符，均在二进制中进行：</p><div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>操作</th><th>说明</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>int二进制0</td><td>0000 0000 0000 0000 0000 0000 0000 0000</td></tr><tr><td>int二进制-1</td><td>1111 1111 1111 1111 1111 1111 1111 1111</td></tr><tr><td>右移操作符&gt;&gt;</td><td>正数右移一步高位补0，右移31补得到十进制0；负数右移一步高位补1，右移31补得到十进制-1</td></tr><tr><td>按位非操作符~</td><td>也叫取反操作符，为一元操作符，对自身每一位进行取反——为0取-1，为1取0。故二进制0取反为-1，-1取反为0</td></tr><tr><td>按位与操作符&amp;</td><td>二元操作符，对应位均为1取1，否者取0。故十进制0与位操作结果必为0，-1与位操作结果必为原数值</td></tr><tr></tr>
            </tbody>
        </table>
        </div><p>结果大家可以自行测试。</p><p>在大数据处理过程中，要尽量避免使用if条件语句产生分支。</p>
        </div>
        <div class="post-image"></div>
        <ul class="post-menu"></ul>
    </div></div>
        </div>
    </div>
    
    <script>
        window.addEventListener("popstate", function (e) {
            let path = window.location.href
            let url_segs = path.split('#')
            if (url_segs.length >= 3) {
                let cat = url_segs[1]
                let param = url_segs[2]
                if (cat === 'post') {
                    window.eventHub.emit('post-detail', { data: param })
                }
            } else {
                window.eventHub.emit('post-list', { pushStat: false })
            }
        }, false);
    </script>


<script src="/js/util/function.js?version=1723974088984"></script><script src="/js/util/markdown.js?version=1723974088984"></script><script src="/js/util/event-hub.js?version=1723974088984"></script><script src="/js/entity.js?version=1723974088984"></script><script src="/js/3rdparty/prism.js?version=1723974088984"></script><script src="https://static.codepen.io/assets/embed/ei.js?version=1723974088984"></script><script src="/js/util/saveData.js?version=1723974088984"></script></body></html>